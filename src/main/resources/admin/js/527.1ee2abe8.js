(self["webpackChunkhalo_admin"]=self["webpackChunkhalo_admin"]||[]).push([[527],{28644:function(e,t,n){"use strict";n.d(t,{M:function(){return s},o:function(){return u}});var r=n(35702),o=n(57400),a=function(){return a=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},a.apply(this,arguments)};function i(e){var t="请使用 '@".concat(e,"' 事件，不要放在 props 中");return t+"\nPlease use '@".concat(e,"' event instead of props")}var s=r["default"].extend({render:function(e){return e("div",{ref:"box"})},name:"Editor",data:function(){return{curValue:"",editor:null}},props:["defaultContent","defaultConfig","mode","defaultHtml","value"],mounted:function(){this.create()},watch:{value:function(e){e===this.curValue||this.setHtml(e)}},methods:{setHtml:function(e){var t=this.editor;if(null!=t){var n=t.isDisabled(),r=t.isFocused(),a=JSON.stringify(t.selection);if(t.enable(),t.focus(),t.select([]),t.deleteFragment(),o.SlateTransforms.setNodes(t,{type:"paragraph"},{mode:"highest"}),t.dangerouslyInsertHtml(e),r||(t.deselect(),t.blur()),n&&(t.deselect(),t.disable()),t.isFocused())try{t.select(JSON.parse(a))}catch(e){t.select(o.SlateEditor.start(t,[]))}}},create:function(){var e=this;if(null!=this.$refs.box){var t=this.defaultConfig||{},n=JSON.stringify(Array.isArray(this.defaultContent)?this.defaultContent:[]);(0,o.createEditor)({selector:this.$refs.box,html:this.defaultHtml||this.value||"",config:a(a({},t),{onCreated:function(n){if(e.editor=Object.seal(n),e.$emit("onCreated",n),t.onCreated){var r=i("onCreated");throw new Error(r)}},onChange:function(n){var r=n.getHtml();if(e.curValue=r,e.$emit("input",r),e.$emit("onChange",n),t.onChange){var o=i("onChange");throw new Error(o)}},onDestroyed:function(n){if(e.$emit("onDestroyed",n),t.onDestroyed){var r=i("onDestroyed");throw new Error(r)}},onMaxLength:function(n){if(e.$emit("onMaxLength",n),t.onMaxLength){var r=i("onMaxLength");throw new Error(r)}},onFocus:function(n){if(e.$emit("onFocus",n),t.onFocus){var r=i("onFocus");throw new Error(r)}},onBlur:function(n){if(e.$emit("onBlur",n),t.onBlur){var r=i("onBlur");throw new Error(r)}},customAlert:function(n,r){if(e.$emit("customAlert",n,r),t.customAlert){var o=i("customAlert");throw new Error(o)}},customPaste:function(n,r){if(t.customPaste){var o=i("customPaste");throw new Error(o)}var a;return e.$emit("customPaste",n,r,(function(e){a=e})),a}}),content:JSON.parse(n),mode:this.mode||"default"})}}}}),u=r["default"].extend({name:"Toolbar",render:function(e){return e("div",{ref:"box"})},props:["editor","defaultConfig","mode"],methods:{create:function(e){null!=this.$refs.box&&null!=e&&(o.DomEditor.getToolbar(e)||(0,o.createToolbar)({editor:e,selector:this.$refs.box,config:this.defaultConfig||{},mode:this.mode||"default"}))}},watch:{editor:{handler:function(e){null!=e&&this.create(e)},immediate:!0}}})},75935:function(e,t,n){var r=n(32640);e.exports=r((function(){if("function"==typeof ArrayBuffer){var e=new ArrayBuffer(8);Object.isExtensible(e)&&Object.defineProperty(e,"a",{value:8})}}))},77089:function(e,t,n){var r=n(32640);e.exports=!r((function(){return Object.isExtensible(Object.preventExtensions({}))}))},45748:function(e,t,n){var r=n(79644),o=n(33691),a=n(32418),i=n(10445),s=n(61746),u=n(83933).f,c=n(57961),l=n(54503),f=n(85236),h=n(24854),d=n(77089),p=!1,g=h("meta"),v=0,m=function(e){u(e,g,{value:{objectID:"O"+v++,weakData:{}}})},b=function(e,t){if(!i(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!s(e,g)){if(!f(e))return"F";if(!t)return"E";m(e)}return e[g].objectID},S=function(e,t){if(!s(e,g)){if(!f(e))return!0;if(!t)return!1;m(e)}return e[g].weakData},w=function(e){return d&&p&&f(e)&&!s(e,g)&&m(e),e},y=function(){C.enable=function(){},p=!0;var e=c.f,t=o([].splice),n={};n[g]=1,e(n).length&&(c.f=function(n){for(var r=e(n),o=0,a=r.length;o<a;o++)if(r[o]===g){t(r,o,1);break}return r},r({target:"Object",stat:!0,forced:!0},{getOwnPropertyNames:l.f}))},C=e.exports={enable:y,fastKey:b,getWeakData:S,onFreeze:w};a[g]=!0},85236:function(e,t,n){var r=n(32640),o=n(10445),a=n(95825),i=n(75935),s=Object.isExtensible,u=r((function(){s(1)}));e.exports=u||i?function(e){return!!o(e)&&((!i||"ArrayBuffer"!=a(e))&&(!s||s(e)))}:s},55496:function(e,t,n){var r=n(79644),o=n(10445),a=n(45748).onFreeze,i=n(77089),s=n(32640),u=Object.seal,c=s((function(){u(1)}));r({target:"Object",stat:!0,forced:c,sham:!i},{seal:function(e){return u&&o(e)?u(a(e)):e}})},86763:function(e,t,n){var r="Expected a function",o=NaN,a="[object Symbol]",i=/^\s+|\s+$/g,s=/^[-+]0x[0-9a-f]+$/i,u=/^0b[01]+$/i,c=/^0o[0-7]+$/i,l=parseInt,f="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,h="object"==typeof self&&self&&self.Object===Object&&self,d=f||h||Function("return this")(),p=Object.prototype,g=p.toString,v=Math.max,m=Math.min,b=function(){return d.Date.now()};function S(e,t,n){var o,a,i,s,u,c,l=0,f=!1,h=!1,d=!0;if("function"!=typeof e)throw new TypeError(r);function p(t){var n=o,r=a;return o=a=void 0,l=t,s=e.apply(r,n),s}function g(e){return l=e,u=setTimeout(C,t),f?p(e):s}function S(e){var n=e-c,r=e-l,o=t-n;return h?m(o,i-r):o}function y(e){var n=e-c,r=e-l;return void 0===c||n>=t||n<0||h&&r>=i}function C(){var e=b();if(y(e))return T(e);u=setTimeout(C,S(e))}function T(e){return u=void 0,d&&o?p(e):(o=a=void 0,s)}function k(){void 0!==u&&clearTimeout(u),l=0,o=c=a=u=void 0}function $(){return void 0===u?s:T(b())}function O(){var e=b(),n=y(e);if(o=arguments,a=this,c=e,n){if(void 0===u)return g(c);if(h)return u=setTimeout(C,t),p(c)}return void 0===u&&(u=setTimeout(C,t)),s}return t=x(t)||0,w(n)&&(f=!!n.leading,h="maxWait"in n,i=h?v(x(n.maxWait)||0,t):i,d="trailing"in n?!!n.trailing:d),O.cancel=k,O.flush=$,O}function w(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function y(e){return!!e&&"object"==typeof e}function C(e){return"symbol"==typeof e||y(e)&&g.call(e)==a}function x(e){if("number"==typeof e)return e;if(C(e))return o;if(w(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=w(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(i,"");var n=u.test(e);return n||c.test(e)?l(e.slice(2),n?2:8):s.test(e)?o:+e}e.exports=S},61527:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return b}});var r=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("page-view",{attrs:{"sub-title":e.sheetToStage.inProgress?"当前内容已保存，但还未发布。":"",title:e.sheetToStage.title?e.sheetToStage.title:"新页面",affix:""}},[n("template",{slot:"extra"},[n("a-space",[n("a-button",{attrs:{loading:e.previewSaving},on:{click:e.handlePreviewClick}},[e._v("预览")]),n("a-button",{attrs:{type:"primary"},on:{click:function(t){e.sheetSettingVisible=!0}}},[e._v("发布")])],1)],1),n("a-row",{attrs:{gutter:12}},[n("a-col",{attrs:{span:24}},[n("div",{staticClass:"mb-4"},[n("a-input",{attrs:{placeholder:"请输入页面标题",size:"large"},model:{value:e.sheetToStage.title,callback:function(t){e.$set(e.sheetToStage,"title",t)},expression:"sheetToStage.title"}})],1),n("div",{attrs:{id:"editor"}},[n("Toolbar",{staticStyle:{"border-bottom":"1px solid #ccc"},attrs:{editor:e.editor,mode:e.mode,defaultConfig:e.toolbarConfig}}),n("Editor",{staticStyle:{height:"700px","overflow-y":"hidden"},attrs:{defaultConfig:e.editorConfig,mode:e.mode},on:{onCreated:e.onCreated,onChange:e.onContentChange},model:{value:e.sheetToStage.originalContent,callback:function(t){e.$set(e.sheetToStage,"originalContent",t)},expression:"sheetToStage.originalContent"}})],1)])],1),n("SheetSettingModal",{attrs:{sheet:e.sheetToStage,savedCallback:e.onSheetSavedCallback,visible:e.sheetSettingVisible},on:{"update:visible":function(t){e.sheetSettingVisible=t},onUpdate:e.onUpdateFromSetting}})],2)},o=[],a=n(46519),i=(n(70315),n(12566),n(55496),n(30535),n(85018),n(21082),n(71101)),s=n(81978),u=n(28644),c=n(17767),l=n(8384),f=n(18608),h=n(86763),d=n.n(h),p={components:{PageView:i.B4,SheetSettingModal:s.Z,Editor:u.M,Toolbar:u.o},mixins:[c.jB,c.KT,c.g3],data:function(){return{editor:null,sheetSettingVisible:!1,sheetToStage:{editorType:"RICHTEXT",keepRaw:!0},contentChanges:0,previewSaving:!1,toolbarConfig:{insertKeys:{index:22,keys:["uploadAttachment"]}},editorConfig:{placeholder:"请输入内容...",MENU_CONF:{uploadImage:{server:"/api/admin/attachments/upload",customUpload:this.handleCustomUploadImage},uploadVideo:{server:"/api/admin/attachments/upload",customUpload:this.handleCustomUploadVideo},uploadAttachment:{server:"/api/admin/attachments/upload",customUpload:this.handleCustomUploadAttachment}}},mode:"default"}},beforeRouteEnter:function(e,t,n){var r=e.query.sheetId;n(function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n,o;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!r){e.next=6;break}return e.next=3,f.Z.sheet.get(Number(r));case 3:n=e.sent,o=n.data,t.sheetToStage=o;case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())},destroyed:function(){window.onbeforeunload&&(window.onbeforeunload=null)},beforeRouteLeave:function(e,t,n){var r=this.$createElement;this.contentChanges<=1?n():this.$confirm({title:"当前页面数据未保存，确定要离开吗？",content:function(){return r("div",{style:"color:red;"},["如果离开当面页面，你的数据很可能会丢失！"])},onOk:function(){n()},onCancel:function(){n(!1)}})},mounted:function(){window.onbeforeunload=function(e){return e=e||window.event,e&&(e.returnValue="当前页面数据未保存，确定要离开吗？"),"当前页面数据未保存，确定要离开吗？"}},beforeMount:function(){document.addEventListener("keydown",this.onRegisterSaveShortcut)},beforeDestroy:function(){document.removeEventListener("keydown",this.onRegisterSaveShortcut)},methods:{onCreated:function(e){this.editor=Object.seal(e)},onRegisterSaveShortcut:function(e){!e.ctrlKey&&!e.metaKey||e.altKey||e.shiftKey||83!==e.keyCode||(e.preventDefault(),e.stopPropagation(),this.handleSaveDraft())},handleSaveDraft:d()((0,a.Z)(regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!this.sheetToStage.id){e.next=16;break}return e.prev=1,e.next=4,f.Z.sheet.updateDraftById(this.sheetToStage.id,this.sheetToStage.originalContent,this.sheetToStage.content,!0);case 4:t=e.sent,n=t.data,this.sheetToStage.inProgress=n.inProgress,this.handleRestoreSavedStatus(),this.$message.success({content:"内容已保存",duration:.5}),e.next=14;break;case 11:e.prev=11,e.t0=e["catch"](1),this.$log.error("Failed to update sheet content",e.t0);case 14:e.next=18;break;case 16:return e.next=18,this.handleCreateSheet();case 18:case"end":return e.stop()}}),e,this,[[1,11]])}))),300),handleCreateSheet:function(){var e=this;return(0,a.Z)(regeneratorRuntime.mark((function t(){var n,r,o;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.sheetToStage.title||(e.sheetToStage.title=(0,l._)(new Date,"YYYY-MM-DD-HH-mm-ss")),t.prev=1,e.sheetToStage.keepRaw=!0,t.next=5,f.Z.sheet.create(e.sheetToStage);case 5:n=t.sent,r=n.data,e.sheetToStage=r,e.handleRestoreSavedStatus(),o=e.$router.history.current.path,e.$router.replace({path:o,query:{sheetId:e.sheetToStage.id}}).catch((function(e){return e})),e.$message.success({content:"页面已创建",duration:.5}),t.next=17;break;case 14:t.prev=14,t.t0=t["catch"](1),e.$log.error("Failed to create sheet",t.t0);case 17:case"end":return t.stop()}}),t,null,[[1,14]])})))()},handlePreviewClick:function(){var e=this;return(0,a.Z)(regeneratorRuntime.mark((function t(){var n,r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.previewSaving=!0,!e.sheetToStage.id){t.next=9;break}return t.next=4,f.Z.sheet.updateDraftById(e.sheetToStage.id,e.sheetToStage.originalContent,e.sheetToStage.content,!0);case 4:n=t.sent,r=n.data,e.sheetToStage.inProgress=r.inProgress,t.next=11;break;case 9:return t.next=11,e.handleCreateSheet();case 11:return t.next=13,e.handleOpenPreview();case 13:case"end":return t.stop()}}),t)})))()},handleOpenPreview:function(){var e=this;return(0,a.Z)(regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,f.Z.sheet.getPreviewLinkById(e.sheetToStage.id);case 3:n=t.sent,window.open(n,"_blank"),e.handleRestoreSavedStatus(),t.next=11;break;case 8:t.prev=8,t.t0=t["catch"](0),e.$log.error("Failed to get preview link",t.t0);case 11:return t.prev=11,setTimeout((function(){e.previewSaving=!1}),400),t.finish(11);case 14:case"end":return t.stop()}}),t,null,[[0,8,11,14]])})))()},handleRestoreSavedStatus:function(){this.contentChanges=0},onContentChange:function(e){var t=e.originalContent,n=e.renderContent;this.contentChanges++,this.sheetToStage.originalContent=t,this.sheetToStage.content=n},onSheetSavedCallback:function(){this.contentChanges=0,this.$router.push({name:"SheetList",query:{activeKey:"custom"}})},onUpdateFromSetting:function(e){this.sheetToStage=e},handleCustomUploadImage:function(e,t){var n=this;f.Z.attachment.upload(e).then((function(e){var n=e.data;t("https://cern-api.fists.cn".concat(n.path))})).catch((function(e){n.$log.error("upload image error: ",e)}))},handleCustomUploadVideo:function(e,t){var n=this;f.Z.attachment.upload(e).then((function(e){var n=e.data;t("https://cern-api.fists.cn".concat(n.path))})).catch((function(e){n.$log.error("upload image error: ",e)}))},handleCustomUploadAttachment:function(e,t){var n=this;f.Z.attachment.upload(e).then((function(e){var n=e.data;t("https://cern-api.fists.cn".concat(n.path),"".concat(n.name))})).catch((function(e){n.$log.error("upload attachment error: ",e)}))}}},g=p,v=n(42177),m=(0,v.Z)(g,r,o,!1,null,null,null),b=m.exports}}]);