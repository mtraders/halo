(self["webpackChunkhalo_admin"]=self["webpackChunkhalo_admin"]||[]).push([[451],{28644:function(t,e,n){"use strict";n.d(e,{M:function(){return s},o:function(){return u}});var o=n(35702),r=n(57400),a=function(){return a=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},a.apply(this,arguments)};function i(t){var e="请使用 '@".concat(t,"' 事件，不要放在 props 中");return e+"\nPlease use '@".concat(t,"' event instead of props")}var s=o["default"].extend({render:function(t){return t("div",{ref:"box"})},name:"Editor",data:function(){return{curValue:"",editor:null}},props:["defaultContent","defaultConfig","mode","defaultHtml","value"],mounted:function(){this.create()},watch:{value:function(t){t===this.curValue||this.setHtml(t)}},methods:{setHtml:function(t){var e=this.editor;if(null!=e){var n=e.isDisabled(),o=e.isFocused(),a=JSON.stringify(e.selection);if(e.enable(),e.focus(),e.select([]),e.deleteFragment(),r.SlateTransforms.setNodes(e,{type:"paragraph"},{mode:"highest"}),e.dangerouslyInsertHtml(t),o||(e.deselect(),e.blur()),n&&(e.deselect(),e.disable()),e.isFocused())try{e.select(JSON.parse(a))}catch(t){e.select(r.SlateEditor.start(e,[]))}}},create:function(){var t=this;if(null!=this.$refs.box){var e=this.defaultConfig||{},n=JSON.stringify(Array.isArray(this.defaultContent)?this.defaultContent:[]);(0,r.createEditor)({selector:this.$refs.box,html:this.defaultHtml||this.value||"",config:a(a({},e),{onCreated:function(n){if(t.editor=Object.seal(n),t.$emit("onCreated",n),e.onCreated){var o=i("onCreated");throw new Error(o)}},onChange:function(n){var o=n.getHtml();if(t.curValue=o,t.$emit("input",o),t.$emit("onChange",n),e.onChange){var r=i("onChange");throw new Error(r)}},onDestroyed:function(n){if(t.$emit("onDestroyed",n),e.onDestroyed){var o=i("onDestroyed");throw new Error(o)}},onMaxLength:function(n){if(t.$emit("onMaxLength",n),e.onMaxLength){var o=i("onMaxLength");throw new Error(o)}},onFocus:function(n){if(t.$emit("onFocus",n),e.onFocus){var o=i("onFocus");throw new Error(o)}},onBlur:function(n){if(t.$emit("onBlur",n),e.onBlur){var o=i("onBlur");throw new Error(o)}},customAlert:function(n,o){if(t.$emit("customAlert",n,o),e.customAlert){var r=i("customAlert");throw new Error(r)}},customPaste:function(n,o){if(e.customPaste){var r=i("customPaste");throw new Error(r)}var a;return t.$emit("customPaste",n,o,(function(t){a=t})),a}}),content:JSON.parse(n),mode:this.mode||"default"})}}}}),u=o["default"].extend({name:"Toolbar",render:function(t){return t("div",{ref:"box"})},props:["editor","defaultConfig","mode"],methods:{create:function(t){null!=this.$refs.box&&null!=t&&(r.DomEditor.getToolbar(t)||(0,r.createToolbar)({editor:t,selector:this.$refs.box,config:this.defaultConfig||{},mode:this.mode||"default"}))}},watch:{editor:{handler:function(t){null!=t&&this.create(t)},immediate:!0}}})},75935:function(t,e,n){var o=n(32640);t.exports=o((function(){if("function"==typeof ArrayBuffer){var t=new ArrayBuffer(8);Object.isExtensible(t)&&Object.defineProperty(t,"a",{value:8})}}))},77089:function(t,e,n){var o=n(32640);t.exports=!o((function(){return Object.isExtensible(Object.preventExtensions({}))}))},45748:function(t,e,n){var o=n(79644),r=n(33691),a=n(32418),i=n(10445),s=n(61746),u=n(83933).f,c=n(57961),l=n(54503),f=n(85236),d=n(24854),p=n(77089),h=!1,g=d("meta"),v=0,m=function(t){u(t,g,{value:{objectID:"O"+v++,weakData:{}}})},b=function(t,e){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!s(t,g)){if(!f(t))return"F";if(!e)return"E";m(t)}return t[g].objectID},S=function(t,e){if(!s(t,g)){if(!f(t))return!0;if(!e)return!1;m(t)}return t[g].weakData},w=function(t){return p&&h&&f(t)&&!s(t,g)&&m(t),t},y=function(){C.enable=function(){},h=!0;var t=c.f,e=r([].splice),n={};n[g]=1,t(n).length&&(c.f=function(n){for(var o=t(n),r=0,a=o.length;r<a;r++)if(o[r]===g){e(o,r,1);break}return o},o({target:"Object",stat:!0,forced:!0},{getOwnPropertyNames:l.f}))},C=t.exports={enable:y,fastKey:b,getWeakData:S,onFreeze:w};a[g]=!0},85236:function(t,e,n){var o=n(32640),r=n(10445),a=n(95825),i=n(75935),s=Object.isExtensible,u=o((function(){s(1)}));t.exports=u||i?function(t){return!!r(t)&&((!i||"ArrayBuffer"!=a(t))&&(!s||s(t)))}:s},55496:function(t,e,n){var o=n(79644),r=n(10445),a=n(45748).onFreeze,i=n(77089),s=n(32640),u=Object.seal,c=s((function(){u(1)}));o({target:"Object",stat:!0,forced:c,sham:!i},{seal:function(t){return u&&r(t)?u(a(t)):t}})},86763:function(t,e,n){var o="Expected a function",r=NaN,a="[object Symbol]",i=/^\s+|\s+$/g,s=/^[-+]0x[0-9a-f]+$/i,u=/^0b[01]+$/i,c=/^0o[0-7]+$/i,l=parseInt,f="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,d="object"==typeof self&&self&&self.Object===Object&&self,p=f||d||Function("return this")(),h=Object.prototype,g=h.toString,v=Math.max,m=Math.min,b=function(){return p.Date.now()};function S(t,e,n){var r,a,i,s,u,c,l=0,f=!1,d=!1,p=!0;if("function"!=typeof t)throw new TypeError(o);function h(e){var n=r,o=a;return r=a=void 0,l=e,s=t.apply(o,n),s}function g(t){return l=t,u=setTimeout(C,e),f?h(t):s}function S(t){var n=t-c,o=t-l,r=e-n;return d?m(r,i-o):r}function y(t){var n=t-c,o=t-l;return void 0===c||n>=e||n<0||d&&o>=i}function C(){var t=b();if(y(t))return T(t);u=setTimeout(C,S(t))}function T(t){return u=void 0,p&&r?h(t):(r=a=void 0,s)}function k(){void 0!==u&&clearTimeout(u),l=0,r=c=a=u=void 0}function $(){return void 0===u?s:T(b())}function O(){var t=b(),n=y(t);if(r=arguments,a=this,c=t,n){if(void 0===u)return g(c);if(d)return u=setTimeout(C,e),h(c)}return void 0===u&&(u=setTimeout(C,e)),s}return e=x(e)||0,w(n)&&(f=!!n.leading,d="maxWait"in n,i=d?v(x(n.maxWait)||0,e):i,p="trailing"in n?!!n.trailing:p),O.cancel=k,O.flush=$,O}function w(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function y(t){return!!t&&"object"==typeof t}function C(t){return"symbol"==typeof t||y(t)&&g.call(t)==a}function x(t){if("number"==typeof t)return t;if(C(t))return r;if(w(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=w(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=t.replace(i,"");var n=u.test(t);return n||c.test(t)?l(t.slice(2),n?2:8):s.test(t)?r:+t}t.exports=S},11451:function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return b}});var o=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("page-view",{attrs:{"sub-title":t.postToStage.inProgress?"当前内容已保存，但还未发布。":"",title:t.postToStage.title?t.postToStage.title:"新文章",affix:""}},[n("template",{slot:"extra"},[n("a-space",[n("a-button",{attrs:{loading:t.previewSaving},on:{click:t.handlePreviewClick}},[t._v("预览")]),n("a-button",{attrs:{type:"primary"},on:{click:function(e){t.postSettingVisible=!0}}},[t._v("发布")])],1)],1),n("a-row",{attrs:{gutter:12}},[n("a-col",{attrs:{span:24}},[n("div",{staticClass:"mb-4"},[n("a-input",{attrs:{placeholder:"请输入文章标题",size:"large"},model:{value:t.postToStage.title,callback:function(e){t.$set(t.postToStage,"title",e)},expression:"postToStage.title"}})],1),n("div",{attrs:{id:"editor"}},[n("div",{staticStyle:{border:"1px solid #ccc"}},[n("Toolbar",{staticStyle:{"border-bottom":"1px solid #ccc"},attrs:{editor:t.editor,mode:t.mode,defaultConfig:t.toolbarConfig}}),n("Editor",{staticStyle:{height:"700px","overflow-y":"hidden"},attrs:{defaultConfig:t.editorConfig,mode:t.mode},on:{onCreated:t.onCreated,onChange:t.onContentChange},model:{value:t.postToStage.originalContent,callback:function(e){t.$set(t.postToStage,"originalContent",e)},expression:"postToStage.originalContent"}})],1)])])],1),n("PostSettingModal",{attrs:{post:t.postToStage,savedCallback:t.onPostSavedCallback,visible:t.postSettingVisible},on:{"update:visible":function(e){t.postSettingVisible=e},onUpdate:t.onUpdateFromSetting}})],2)},r=[],a=n(46519),i=(n(70315),n(12566),n(55496),n(21082),n(33295)),s=n(28644),u=n(71101),c=n(17767),l=n(8384),f=n(18608),d=n(86763),p=n.n(d),h={mixins:[c.jB,c.KT,c.g3],components:{PostSettingModal:i.Z,Editor:s.M,Toolbar:s.o,PageView:u.B4},data:function(){return{editor:null,postSettingVisible:!1,postToStage:{editorType:"RICHTEXT",keepRaw:!0},contentChanges:0,previewSaving:!1,toolbarConfig:{insertKeys:{index:22,keys:["uploadAttachment"]}},editorConfig:{placeholder:"请输入内容...",MENU_CONF:{uploadImage:{server:"/api/admin/attachments/upload",customUpload:this.handleCustomUploadImage},uploadVideo:{server:"/api/admin/attachments/upload",customUpload:this.handleCustomUploadVideo},uploadAttachment:{server:"/api/admin/attachments/upload",customUpload:this.handleCustomUploadAttachment}}},mode:"default"}},beforeRouteEnter:function(t,e,n){var o=t.query.postId;n(function(){var t=(0,a.Z)(regeneratorRuntime.mark((function t(e){var n,r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!o){t.next=6;break}return t.next=3,f.Z.post.get(Number(o));case 3:n=t.sent,r=n.data,e.postToStage=r;case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())},destroyed:function(){window.onbeforeunload&&(window.onbeforeunload=null)},beforeRouteLeave:function(t,e,n){var o=this.$createElement;this.contentChanges<=1?n():this.$confirm({title:"当前页面数据未保存，确定要离开吗？",content:function(){return o("div",{style:"color:red;"},["如果离开当面页面，你的数据很可能会丢失！"])},onOk:function(){n()},onCancel:function(){n(!1)}})},mounted:function(){window.onbeforeunload=function(t){return t=t||window.event,t&&(t.returnValue="当前页面数据未保存，确定要离开吗？"),"当前页面数据未保存，确定要离开吗？"}},beforeMount:function(){document.addEventListener("keydown",this.onRegisterSaveShortcut)},beforeDestroy:function(){var t=this.editor;null!=t&&(t.destroy(),document.removeEventListener("keydown",this.onRegisterSaveShortcut))},methods:{onCreated:function(t){this.editor=Object.seal(t)},onRegisterSaveShortcut:function(t){!t.ctrlKey&&!t.metaKey||t.altKey||t.shiftKey||83!==t.keyCode||(t.preventDefault(),t.stopPropagation(),this.handleSaveDraft())},handleSaveDraft:p()((0,a.Z)(regeneratorRuntime.mark((function t(){var e,n;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!this.postToStage.id){t.next=16;break}return t.prev=1,t.next=4,f.Z.post.updateDraftById(this.postToStage.id,this.postToStage.originalContent,this.postToStage.content,!0);case 4:e=t.sent,n=e.data,this.postToStage.inProgress=n.inProgress,this.handleRestoreSavedStatus(),this.$message.success({content:"内容已保存",duration:.5}),t.next=14;break;case 11:t.prev=11,t.t0=t["catch"](1),this.$log.error("Failed to update post content",t.t0);case 14:t.next=18;break;case 16:return t.next=18,this.handleCreatePost();case 18:case"end":return t.stop()}}),t,this,[[1,11]])}))),300),handleCreatePost:function(){var t=this;return(0,a.Z)(regeneratorRuntime.mark((function e(){var n,o,r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.postToStage.title||(t.postToStage.title=(0,l._)(new Date,"YYYY-MM-DD-HH-mm-ss")),e.prev=1,t.postToStage.keepRaw=!0,e.next=5,f.Z.post.create(t.postToStage);case 5:n=e.sent,o=n.data,t.postToStage=o,t.handleRestoreSavedStatus(),r=t.$router.history.current.path,t.$router.push({path:r,query:{postId:t.postToStage.id}}).catch((function(t){return t})),t.$message.success({content:"文章已创建",duration:.5}),e.next=17;break;case 14:e.prev=14,e.t0=e["catch"](1),t.$log.error("Failed to create post",e.t0);case 17:case"end":return e.stop()}}),e,null,[[1,14]])})))()},handlePreviewClick:function(){var t=this;return(0,a.Z)(regeneratorRuntime.mark((function e(){var n,o;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.previewSaving=!0,!t.postToStage.id){e.next=9;break}return e.next=4,f.Z.post.updateDraftById(t.postToStage.id,t.postToStage.originalContent,t.postToStage.content,!0);case 4:n=e.sent,o=n.data,t.postToStage.inProgress=o.inProgress,e.next=11;break;case 9:return e.next=11,t.handleCreatePost();case 11:return e.next=13,t.handleOpenPreview();case 13:case"end":return e.stop()}}),e)})))()},handleOpenPreview:function(){var t=this;return(0,a.Z)(regeneratorRuntime.mark((function e(){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,f.Z.post.getPreviewLinkById(t.postToStage.id);case 3:n=e.sent,window.open(n,"_blank"),t.handleRestoreSavedStatus(),e.next=11;break;case 8:e.prev=8,e.t0=e["catch"](0),t.$log.error("Failed to get preview link",e.t0);case 11:return e.prev=11,setTimeout((function(){t.previewSaving=!1}),400),e.finish(11);case 14:case"end":return e.stop()}}),e,null,[[0,8,11,14]])})))()},handleRestoreSavedStatus:function(){this.contentChanges=0},onContentChange:function(t){this.contentChanges++,this.postToStage.content=t.getText()},onPostSavedCallback:function(){this.contentChanges=0,this.$router.push({name:"PostList"})},onUpdateFromSetting:function(t){this.postToStage=t},handleCustomUploadImage:function(t,e){var n=this;f.Z.attachment.upload(t).then((function(t){var n=t.data;e("https://cern-api.fists.cn".concat(n.path))})).catch((function(t){n.$log.error("upload image error: ",t)}))},handleCustomUploadVideo:function(t,e){var n=this;f.Z.attachment.upload(t).then((function(t){var n=t.data;e("https://cern-api.fists.cn".concat(n.path))})).catch((function(t){n.$log.error("upload video error: ",t)}))},handleCustomUploadAttachment:function(t,e){var n=this;f.Z.attachment.upload(t).then((function(t){var n=t.data;e("https://cern-api.fists.cn".concat(n.path),"".concat(n.name))})).catch((function(t){n.$log.error("upload attachment error: ",t)}))}}},g=h,v=n(42177),m=(0,v.Z)(g,o,r,!1,null,null,null),b=m.exports}}]);